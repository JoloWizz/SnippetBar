<Window x:Class="SnippetBar.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:dd="urn:gong-wpf-dragdrop"
        xmlns:local="clr-namespace:SnippetBar"
        Title="{Binding Source={x:Static local:LanguageManager.Instance}, Path=[AppTitle]}" 
        Height="500" Width="300" 
        Topmost="True" 
        WindowStyle="None" 
        ResizeMode="CanResize"
        AllowsTransparency="True" Background="Transparent"
        ShowInTaskbar="False"
        SizeChanged="Window_SizeChanged"
        Closing="Window_Closing">

    <WindowChrome.WindowChrome>
        <WindowChrome CaptionHeight="0" ResizeBorderThickness="5" CornerRadius="0" GlassFrameThickness="0"/>
    </WindowChrome.WindowChrome>

    <Window.Resources>
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
        <local:SnippetDropHandler x:Key="DropHandlerResource"/>

        <Style TargetType="ScrollBar">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Width" Value="5"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ScrollBar">
                        <Grid>
                            <Track Name="PART_Track" IsDirectionReversed="true">
                                <Track.Thumb>
                                    <Thumb Background="#555" BorderThickness="0"/>
                                </Track.Thumb>
                            </Track>
                        </Grid>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </Window.Resources>

    <Border x:Name="MainBorder" CornerRadius="5" Background="#252526" BorderBrush="#3F3F46" BorderThickness="1">
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="10"/>
                <!-- Flyttyta -->
                <RowDefinition Height="40"/>
                <!-- Header -->
                <RowDefinition Height="Auto"/>
                <!-- Sök -->
                <RowDefinition Height="*"/>
                <!-- Lista -->
            </Grid.RowDefinitions>

            <!-- 0. FLYTTYTA -->
            <Border Grid.Row="0" Background="#181818" MouseLeftButtonDown="Header_MouseDown" Cursor="SizeAll" CornerRadius="4,4,0,0"/>

            <!-- 1. HEADER -->
            <Grid Grid.Row="1" Background="#2D2D30">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <!-- Magnet -->
                    <ColumnDefinition Width="*"/>
                    <!-- Titel -->
                    <ColumnDefinition Width="Auto"/>
                    <!-- MER (...) -->
                    <ColumnDefinition Width="Auto"/>
                    <!-- Stäng -->
                </Grid.ColumnDefinitions>

                <!-- DOCKA -->
                <Button Content="🧲" Click="Dock_Click" ToolTip="Docka / Lossa" 
                        Width="30" Background="Transparent" Foreground="#AAA" BorderThickness="0"/>

                <!-- TITEL -->
                <TextBlock x:Name="txtAppTitle" Grid.Column="1" 
                           Text="{Binding Source={x:Static local:LanguageManager.Instance}, Path=[AppTitle]}" 
                           VerticalAlignment="Center" HorizontalAlignment="Center"
                           Foreground="#888" FontWeight="Bold" IsHitTestVisible="False"/>

                <!-- MER-MENY (...) -->
                <Button Grid.Column="2" Content="•••" Click="MoreMenu_Click" ToolTip="Meny"
                        Width="30" Background="Transparent" Foreground="#AAA" FontWeight="Bold" BorderThickness="0">
                    <Button.ContextMenu>
                        <ContextMenu x:Name="MainMenu" Opened="Menu_Opened" Closed="Menu_Closed">

                            <MenuItem Header="{Binding Source={x:Static local:LanguageManager.Instance}, Path=[MenuNewSnip]}" Click="Add_Click" Icon="📝" FontWeight="Bold"/>
                            <Separator/>

                            <MenuItem Header="{Binding Source={x:Static local:LanguageManager.Instance}, Path=[MenuCategory]}" Icon="📁">
                                <MenuItem Header="{Binding Source={x:Static local:LanguageManager.Instance}, Path=[MenuNewCat]}" Click="NewCat_Click"/>
                                <MenuItem Header="{Binding Source={x:Static local:LanguageManager.Instance}, Path=[MenuRenameCat]}" Click="RenameActiveCat_Click"/>
                                <MenuItem Header="{Binding Source={x:Static local:LanguageManager.Instance}, Path=[MenuDeleteCat]}" Click="DeleteActiveCat_Click"/>
                            </MenuItem>

                            <Separator/>

                            <MenuItem Header="{Binding Source={x:Static local:LanguageManager.Instance}, Path=[MenuMode]}" Icon="⚡">
                                <MenuItem x:Name="MenuModePaste" Header="{Binding Source={x:Static local:LanguageManager.Instance}, Path=[MenuPasteMode]}" IsCheckable="True" Click="SetPasteMode_Click"/>
                                <MenuItem x:Name="MenuModeCopy" Header="{Binding Source={x:Static local:LanguageManager.Instance}, Path=[MenuCopyMode]}" IsCheckable="True" Click="SetCopyMode_Click"/>
                            </MenuItem>

                            <MenuItem x:Name="MenuAutoHide" Header="{Binding Source={x:Static local:LanguageManager.Instance}, Path=[MenuAutoHide]}" IsCheckable="True" Click="ToggleAutoHide_Click"/>

                            <Separator/>

                            <!-- SPRÅK MENY -->
                            <MenuItem Header="{Binding Source={x:Static local:LanguageManager.Instance}, Path=[MenuLanguage]}" Icon="🌐">
                                <MenuItem Header="{Binding Source={x:Static local:LanguageManager.Instance}, Path=[LangSv]}" Click="SetLanguageSv_Click"/>
                                <MenuItem Header="{Binding Source={x:Static local:LanguageManager.Instance}, Path=[LangEn]}" Click="SetLanguageEn_Click"/>
                            </MenuItem>

                            <MenuItem Header="{Binding Source={x:Static local:LanguageManager.Instance}, Path=[MenuSettings]}" Click="ToggleSettings_Click" Icon="⚙️"/>
                            <Separator/>
                            <MenuItem Header="{Binding Source={x:Static local:LanguageManager.Instance}, Path=[MenuExit]}" Click="Exit_Click" Icon="✕" Foreground="#FF5555"/>
                        </ContextMenu>
                    </Button.ContextMenu>
                </Button>

                <!-- STÄNG -->
                <Button Grid.Column="3" Content="✕" Click="Close_Click" ToolTip="Minimera till Tray"
                        Width="30" Background="Transparent" Foreground="#FF5555" BorderThickness="0"/>
            </Grid>

            <!-- 2. SÖKRUTA -->
            <Grid Grid.Row="2" Margin="5">
                <Border Background="#2D2D30" CornerRadius="3" BorderBrush="#3F3F46" BorderThickness="1">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="20"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Text="🔍" VerticalAlignment="Center" HorizontalAlignment="Center" Foreground="#666" FontSize="10"/>
                        <TextBox x:Name="txtSearch" Grid.Column="1"
                                 TextChanged="Search_TextChanged"
                                 Background="Transparent" Foreground="White" BorderThickness="0" 
                                 Height="24" VerticalContentAlignment="Center" FontSize="11"
                                 CaretBrush="White"/>
                        <!-- Bunden Placeholder Text -->
                        <TextBlock Grid.Column="1" 
                                   Text="{Binding Source={x:Static local:LanguageManager.Instance}, Path=[SearchPlaceholder]}" 
                                   IsHitTestVisible="False" 
                                   VerticalAlignment="Center" Foreground="#555" FontSize="11"
                                   Visibility="{Binding ElementName=txtSearch, Path=Text.IsEmpty, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                    </Grid>
                </Border>
            </Grid>

            <!-- 3. FLIKAR & LISTA -->
            <TabControl x:Name="CategoryTabs" Grid.Row="3" 
                        Background="Transparent" BorderThickness="0"
                        TabStripPlacement="Top"
                        DisplayMemberPath="Name"
                        SelectionChanged="Tabs_SelectionChanged">

                <TabControl.ContextMenu>
                    <ContextMenu Opened="Menu_Opened" Closed="Menu_Closed">
                        <MenuItem Header="{Binding Source={x:Static local:LanguageManager.Instance}, Path=[MenuNewCat]}" Click="NewCat_Click"/>
                    </ContextMenu>
                </TabControl.ContextMenu>

                <TabControl.Template>
                    <ControlTemplate TargetType="TabControl">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>
                            <ScrollViewer HorizontalScrollBarVisibility="Disabled" VerticalScrollBarVisibility="Auto" MaxHeight="80" Margin="2,0">
                                <TabPanel x:Name="HeaderPanel" IsItemsHost="True" Background="Transparent"/>
                            </ScrollViewer>

                            <Border Grid.Row="1" Background="#333337" BorderBrush="#3F3F46" BorderThickness="0,1,0,0" Margin="0,0,0,2" CornerRadius="0,0,3,3">
                                <ContentPresenter x:Name="PART_SelectedContentHost" ContentSource="SelectedContent" Margin="0"/>
                            </Border>
                        </Grid>
                    </ControlTemplate>
                </TabControl.Template>

                <TabControl.Resources>
                    <Style TargetType="TabItem">
                        <Setter Property="dd:DragDrop.IsDragSource" Value="False"/>
                        <Setter Property="dd:DragDrop.IsDropTarget" Value="True"/>
                        <Setter Property="dd:DragDrop.DropHandler" Value="{StaticResource DropHandlerResource}"/>

                        <Setter Property="Background" Value="#1E1E1E"/>
                        <Setter Property="Foreground" Value="#888"/>
                        <Setter Property="Margin" Value="0,0,1,0"/>
                        <Setter Property="Padding" Value="8,4"/>
                        <Setter Property="FontSize" Value="11"/>
                        <Setter Property="BorderThickness" Value="0"/>

                        <Setter Property="Template">
                            <Setter.Value>
                                <ControlTemplate TargetType="TabItem">
                                    <Grid>
                                        <Border Name="Border" Background="{TemplateBinding Background}" 
                                                CornerRadius="3,3,0,0" 
                                                BorderBrush="#3F3F46" BorderThickness="1,1,1,0">
                                            <ContentPresenter x:Name="ContentSite" VerticalAlignment="Center" HorizontalAlignment="Center" ContentSource="Header" Margin="{TemplateBinding Padding}"/>
                                        </Border>
                                        <Border Name="Indicator" Background="Transparent" Height="2" VerticalAlignment="Top" HorizontalAlignment="Stretch"/>
                                    </Grid>
                                    <ControlTemplate.Triggers>
                                        <Trigger Property="IsSelected" Value="True">
                                            <Setter TargetName="Border" Property="Background" Value="#333337" />
                                            <Setter TargetName="Border" Property="BorderThickness" Value="1,1,1,0" />
                                            <Setter TargetName="Border" Property="Margin" Value="0,0,1,-1" />
                                            <Setter TargetName="Indicator" Property="Background" Value="#007ACC"/>
                                            <Setter Property="Foreground" Value="White"/>
                                            <Setter Property="Panel.ZIndex" Value="100"/>
                                        </Trigger>
                                        <Trigger Property="IsSelected" Value="False">
                                            <Setter TargetName="Border" Property="Opacity" Value="0.8"/>
                                            <Setter TargetName="Border" Property="Margin" Value="0,0,1,0" />
                                        </Trigger>
                                        <Trigger Property="IsMouseOver" Value="True">
                                            <Setter TargetName="Border" Property="Opacity" Value="1.0"/>
                                            <Setter Property="Foreground" Value="White"/>
                                        </Trigger>
                                    </ControlTemplate.Triggers>
                                </ControlTemplate>
                            </Setter.Value>
                        </Setter>
                    </Style>
                </TabControl.Resources>

                <!-- INNEHÅLL -->
                <TabControl.ContentTemplate>
                    <DataTemplate>
                        <ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">

                            <ScrollViewer.ContextMenu>
                                <ContextMenu Opened="Menu_Opened" Closed="Menu_Closed">
                                    <MenuItem Header="{Binding Source={x:Static local:LanguageManager.Instance}, Path=[MenuNewSnip]}" Click="Add_Click"/>
                                    <MenuItem Header="{Binding Source={x:Static local:LanguageManager.Instance}, Path=[MenuNewCat]}" Click="NewCat_Click"/>
                                    <Separator/>
                                    <MenuItem Header="{Binding Source={x:Static local:LanguageManager.Instance}, Path=[MenuSettings]}" Click="ToggleSettings_Click"/>
                                </ContextMenu>
                            </ScrollViewer.ContextMenu>

                            <ItemsControl ItemsSource="{Binding Snippets}"
                                          dd:DragDrop.IsDragSource="True"
                                          dd:DragDrop.IsDropTarget="True"
                                          dd:DragDrop.DropHandler="{StaticResource DropHandlerResource}"
                                          Padding="4">
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <WrapPanel Orientation="Horizontal" />
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Button Content="{Binding Title}" 
                                                Tag="{Binding}"
                                                Click="Snippet_Click"
                                                MouseDoubleClick="Edit_Click_Double" 
                                                ToolTip="{Binding Content}" 
                                                Margin="2"
                                                Padding="5"
                                                FontSize="11"
                                                Background="{Binding Color}" 
                                                Foreground="White"
                                                BorderThickness="0"
                                                HorizontalAlignment="Stretch"
                                                MinWidth="65">
                                            <Button.Effect>
                                                <DropShadowEffect BlurRadius="4" ShadowDepth="2" Direction="270" Color="Black" Opacity="0.4"/>
                                            </Button.Effect>
                                            <Button.ContextMenu>
                                                <ContextMenu Opened="Menu_Opened" Closed="Menu_Closed">
                                                    <MenuItem Header="{Binding Source={x:Static local:LanguageManager.Instance}, Path=[CtxEdit]}" Click="Edit_Click" Tag="{Binding}"/>
                                                    <Separator/>
                                                    <MenuItem x:Name="MenuRemoveFromCat" Header="{Binding Source={x:Static local:LanguageManager.Instance}, Path=[CtxRemoveFromCat]}" Click="RemoveFromCat_Click" Tag="{Binding}"/>
                                                    <MenuItem Header="{Binding Source={x:Static local:LanguageManager.Instance}, Path=[CtxDeletePerm]}" Click="DeletePermanent_Click" Tag="{Binding}" Foreground="#FF5555"/>
                                                </ContextMenu>
                                            </Button.ContextMenu>
                                            <Button.Resources>
                                                <Style TargetType="Border">
                                                    <Setter Property="CornerRadius" Value="3"/>
                                                </Style>
                                            </Button.Resources>
                                        </Button>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </ScrollViewer>
                    </DataTemplate>
                </TabControl.ContentTemplate>
            </TabControl>

            <!-- INSTÄLLNINGS-OVERLAY -->
            <Grid x:Name="SettingsOverlay" Grid.Row="1" Grid.RowSpan="3" Background="#F21E1E1E" Visibility="Collapsed" Margin="0,35,0,0">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel Margin="10" VerticalAlignment="Top">
                        <TextBlock Text="{Binding Source={x:Static local:LanguageManager.Instance}, Path=[SettingsTitle]}" FontSize="14" FontWeight="Bold" Foreground="White" Margin="0,0,0,15" HorizontalAlignment="Center"/>

                        <TextBlock Text="{Binding Source={x:Static local:LanguageManager.Instance}, Path=[LblTransparency]}" Foreground="#AAA" FontSize="11" Margin="0,0,0,2"/>
                        <CheckBox x:Name="chkTransparent" Content="{Binding Source={x:Static local:LanguageManager.Instance}, Path=[ChkActive]}" 
                                  IsChecked="True" Foreground="White" FontSize="11" Margin="0,0,0,8"
                                  Checked="Settings_Changed" Unchecked="Settings_Changed"/>

                        <TextBlock Text="{Binding Source={x:Static local:LanguageManager.Instance}, Path=[LblOpacity]}" Foreground="#AAA" FontSize="11" Margin="0,0,0,2"/>
                        <Grid Margin="0,0,0,15">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <TextBox x:Name="txtOpacityInput" Text="40" 
                                     Background="#333" Foreground="White" BorderThickness="0" Padding="5,3"
                                     VerticalContentAlignment="Center"
                                     TextChanged="OpacityInput_TextChanged" />
                            <StackPanel Grid.Column="1" Orientation="Vertical">
                                <Button Content="▲" Click="OpacityUp_Click" FontSize="8" Height="12" Width="20" Background="#444" Foreground="White" BorderThickness="0"/>
                                <Button Content="▼" Click="OpacityDown_Click" FontSize="8" Height="12" Width="20" Background="#444" Foreground="White" BorderThickness="0"/>
                            </StackPanel>
                        </Grid>

                        <Separator Background="#444" Margin="0,0,0,15"/>
                        <Button Content="{Binding Source={x:Static local:LanguageManager.Instance}, Path=[BtnClose]}" Click="ToggleSettings_Click" Padding="5" Background="#007ACC" Foreground="White" BorderThickness="0"/>
                    </StackPanel>
                </ScrollViewer>
            </Grid>
        </Grid>
    </Border>
</Window>